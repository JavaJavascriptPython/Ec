if ($query->param('page') && $query->param('page') eq 'login') {
    print $logfh "Login attempt detected\n";

    # Save old params before deleting
    my %old_params = $session->param_hashref ? %{ $session->param_hashref } : ();

    # Destroy old session
    $session->delete;
    $session->flush;

    # Create a new session
    $session = CGI::Session->new("driver:File", undef, { Directory => '/tmp/webadmin/' })
        or die CGI::Session->errstr;

    $session->expire('+1h');

    # Restore old parameters into new session
    foreach my $k (keys %old_params) {
        $session->param($k, $old_params{$k});
    }

    # Add/overwrite login-related parameters
    $session->param('logged_in', 1);
    $session->param('username', $query->param('username') || "guest");

    my $sid_new = $session->id;
    print $logfh "New Session ID after login: $sid_new\n";

    # Issue new cookie
    my $cookie = $query->cookie(
        -name    => 'app_session',
        -value   => $sid_new,
        -expires => '+1h',
    );

    print $query->header(-type => 'text/html', -cookie => $cookie);
    print "<h2>Welcome! Session carried forward.</h2>";
    return;
}